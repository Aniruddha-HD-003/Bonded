{% extends "base.html" %}

{% block title %}Private Chat{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card chat-container">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-comments me-2"></i>
                                Private Chat
                            </h5>
                            <small class="online-status" id="online-status">
                                <i class="fas fa-circle text-success me-1"></i>
                                <span>Online</span>
                            </small>
                        </div>
                        <span class="badge bg-light text-primary" id="unread-badge" style="display: none;"></span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <div class="typing-bubble">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="typing-text">typing...</span>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="message-form" class="d-flex">
                        <input type="hidden" id="receiver" value="Bonded">
                        <input type="text" id="message-input" class="form-control me-2" placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.chat-container {
    height: 80vh;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    max-width: 75%;
}

.message.sent {
    margin-left: auto;
}

.message.received {
    margin-right: auto;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    position: relative;
}

.message.sent .message-content {
    background-color: #007bff;
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message.received .message-content {
    background-color: #e9ecef;
    color: #212529;
    border-bottom-left-radius: 0.25rem;
}

.message-time {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    opacity: 0.8;
}

.message.sent .message-time {
    text-align: right;
    color: #6c757d;
}

.message.received .message-time {
    color: #6c757d;
}

.card-footer {
    background-color: white;
    border-top: 1px solid #dee2e6;
    padding: 1rem;
}

#message-input {
    border-radius: 1.5rem;
    padding: 0.75rem 1rem;
}

.btn-primary {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Online status styling */
.online-status {
    font-size: 0.8rem;
    opacity: 0.9;
}

.online-status i {
    font-size: 0.6rem;
}

/* Typing indicator styling */
.typing-indicator {
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.typing-bubble {
    display: flex;
    gap: 0.2rem;
    padding: 0.5rem;
    background-color: #e9ecef;
    border-radius: 1rem;
    width: fit-content;
}

.typing-bubble span {
    width: 8px;
    height: 8px;
    background-color: #6c757d;
    border-radius: 50%;
    animation: typing 1s infinite ease-in-out;
}

.typing-bubble span:nth-child(1) {
    animation-delay: 0.2s;
}

.typing-bubble span:nth-child(2) {
    animation-delay: 0.4s;
}

.typing-bubble span:nth-child(3) {
    animation-delay: 0.6s;
}

.typing-text {
    font-size: 0.8rem;
    color: #6c757d;
}

@keyframes typing {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}
</style>

<script>
let lastMessageTime = null;
let lastMessageId = 0;
let typingTimeout = null;
let isTyping = false;

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString();
    }
}

function addMessage(message, isNew = false) {
    const messagesDiv = document.getElementById('chat-messages');
    const isSent = message.sender === '{{ session["username"] }}';
    
    // Add date separator if needed
    const messageDate = formatDate(message.created_at);
    if (lastMessageTime !== messageDate) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'text-center my-3';
        dateDiv.innerHTML = `<span class="badge bg-light text-dark">${messageDate}</span>`;
        messagesDiv.appendChild(dateDiv);
        lastMessageTime = messageDate;
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.dataset.messageId = message.id;
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${message.message}
        </div>
        <div class="message-time">
            ${formatTime(message.created_at)}
            ${isSent ? '<i class="fas fa-check-double ms-1"></i>' : ''}
        </div>
    `;
    
    if (isNew) {
        messageDiv.style.opacity = '0';
        messagesDiv.appendChild(messageDiv);
        messageDiv.style.transition = 'opacity 0.3s ease';
        messageDiv.style.opacity = '1';
    } else {
        messagesDiv.appendChild(messageDiv);
    }
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    lastMessageId = Math.max(lastMessageId, message.id);
}

function loadMessages() {
    const receiver = document.getElementById('receiver').value;
    fetch(`/get_messages/${receiver}?after=${lastMessageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages.length > 0) {
                data.messages.forEach(message => {
                    if (message.id > lastMessageId) {
                        addMessage(message);
                    }
                });
                markMessagesAsRead();
            }
        });
}

function markMessagesAsRead() {
    const receiver = document.getElementById('receiver').value;
    fetch(`/mark_read/${receiver}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateUnreadCount();
            }
        });
}

function updateUnreadCount() {
    fetch('/get_unread_count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('unread-badge');
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        });
}

function updateTypingStatus(isTyping) {
    const receiver = document.getElementById('receiver').value;
    fetch('/update_typing_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `receiver=${receiver}&is_typing=${isTyping}`
    });
}

function checkTypingStatus() {
    const receiver = document.getElementById('receiver').value;
    fetch(`/get_typing_status/${receiver}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const typingIndicator = document.getElementById('typing-indicator');
                if (data.is_typing) {
                    typingIndicator.style.display = 'flex';
                } else {
                    typingIndicator.style.display = 'none';
                }
            }
        });
}

function updateOnlineStatus() {
    fetch('/get_online_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const onlineStatus = document.getElementById('online-status');
                if (data.is_online) {
                    onlineStatus.innerHTML = '<i class="fas fa-circle text-success me-1"></i><span>Online</span>';
                } else {
                    onlineStatus.innerHTML = '<i class="fas fa-circle text-secondary me-1"></i><span>Offline</span>';
                }
            }
        });
}

document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('message-input');
    const receiver = document.getElementById('receiver').value;
    const message = messageInput.value.trim();
    
    if (message) {
        // Optimistically add message to UI
        const tempMessage = {
            id: Date.now(), // Temporary ID
            sender: '{{ session["username"] }}',
            receiver: receiver,
            message: message,
            created_at: new Date().toISOString(),
            is_read: 0
        };
        addMessage(tempMessage, true);
        messageInput.value = '';
        updateTypingStatus(false);

        // Send to server
        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `receiver=${receiver}&message=${encodeURIComponent(message)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the temporary message with the real one
                const tempMessageDiv = document.querySelector(`[data-message-id="${tempMessage.id}"]`);
                if (tempMessageDiv) {
                    tempMessageDiv.dataset.messageId = data.message.id;
                }
            }
        });
    }
});

// Handle typing events
document.getElementById('message-input').addEventListener('input', function() {
    if (!isTyping) {
        isTyping = true;
        updateTypingStatus(true);
    }
    
    // Clear existing timeout
    if (typingTimeout) {
        clearTimeout(typingTimeout);
    }
    
    // Set new timeout
    typingTimeout = setTimeout(() => {
        isTyping = false;
        updateTypingStatus(false);
    }, 2000);
});

// Load messages and set up periodic updates
loadMessages();
setInterval(loadMessages, 2000);
setInterval(updateUnreadCount, 5000);
setInterval(checkTypingStatus, 1000);
setInterval(updateOnlineStatus, 5000);

// Initial updates
updateUnreadCount();
updateOnlineStatus();
</script>
{% endblock %} 